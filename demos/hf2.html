<!DOCTYPE html>
<html>
  <head>
    <title>cannon.js - Heightfield demo</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  </head>
  <body>
    <script src="../build/cannon.js"></script>
    <script src="../build/cannon.demo.js"></script>
    <script src="../libs/dat.gui.js"></script>
    <script src="../libs/Three.js"></script>
    <script src="../libs/TrackballControls.js"></script>
    <script src="../libs/Detector.js"></script>
    <script src="../libs/Stats.js"></script>
    <script src="../libs/smoothie.js"></script>
    <script>

        var demo = new CANNON.Demo();

        demo.addScene("Heightfield", function () {

            // Init world
            var world = demo.getWorld();
            world.gravity.set(0, 0, -10);
            world.broadphase = new CANNON.NaiveBroadphase();

            // Create a matrix of height values
            var matrix = [];
            var sizeX = 20,
                sizeY = 5;
            for (var i = 0; i < sizeX; i++) {
                matrix.push([]);
                for (var j = 0; j < sizeY; j++) {
                    var height = 2*Math.sin(i/sizeX * Math.PI * 2) ;
                    if(j===0 || j === sizeY-2)
                      height += 1;
                    matrix[i].push(height);

                }
            }

            // Create the heightfield
            var hfShape = new CANNON.Heightfield(matrix, {
                elementSize: 1
            });
            var hfBody = new CANNON.Body({ mass: 0 });
            hfBody.addShape(hfShape);
            hfBody.position.set(-sizeX * hfShape.elementSize / 2, -30, -10);
            world.addBody(hfBody);
            demo.addVisual(hfBody);


          // Create a matrix of U shape
          var matrixU = [];
          for (var i = 0; i < sizeX; i++) {
            matrixU.push([]);
            for (var j = 0; j < sizeY; j++) {
              var height = 10 * Math.sin(i / sizeX * Math.PI * 1 + Math.PI);
              if(j===0 || j === sizeY-2)
                height += 1;
              matrixU[i].push(height);
            }
          }

          // Create the U shape
          var UShape = new CANNON.Heightfield(matrixU, {
            elementSize: 1
          });
          var UBody = new CANNON.Body({ mass: 0 });
          UBody.addShape(UShape);
          UBody.position.set(-sizeX * UShape.elementSize / 2, -30, -30);
          world.addBody(UBody);
          demo.addVisual(UBody);


          // Create a matrix of S shape
          var matrixS = [];
          for (var i = 0; i < sizeX; i++) {
            matrixS.push([]);
            for (var j = 0; j < sizeY; j++) {
              var height = 2*Math.cos(i/sizeX * Math.PI * 3 + 2*Math.PI);
              if(j===0 || j === sizeY-2)
                height += 1;
              matrixS[i].push(height);
            }
          }

          // Create the S shape
          var SShape = new CANNON.Heightfield(matrixS, {
            elementSize: 1
          });
          var SBody = new CANNON.Body({ mass: 0 });
          SBody.addShape(SShape);
          SBody.position.set(-sizeX * SShape.elementSize / 2, -30, -20);
          world.addBody(SBody);
          demo.addVisual(SBody);


            // Add spheres
            var mass = 1;
            for(var i=0; i<sizeX - 1; i++){
                for (var j = 0; j < sizeY - 1; j++) {
                    if(i===0 || i >= sizeX-2 || j===0 || j >= sizeY-2)
                        continue;
                    // if (i=== 10 && j===5) {
                        var sphereShape = new CANNON.Sphere(0.2);
                        var sphereBody = new CANNON.Body({ mass: mass });
                        sphereBody.addShape(sphereShape);
                        sphereBody.position.set(0.25 + i, j, 3);
                        sphereBody.position.vadd(hfBody.position, sphereBody.position);
                        world.addBody(sphereBody);
                        demo.addVisual(sphereBody);


                      var sphereShape = new CANNON.Sphere(0.2);
                      var sphereBody = new CANNON.Body({ mass: mass });
                      sphereBody.addShape(sphereShape);
                      sphereBody.position.set(-2.1 + i, j, -5);
                      sphereBody.position.vadd(hfBody.position, sphereBody.position);
                      world.addBody(sphereBody);
                      demo.addVisual(sphereBody);


                      var sphereShape = new CANNON.Sphere(0.2);
                      var sphereBody = new CANNON.Body({ mass: mass });
                      sphereBody.addShape(sphereShape);
                      sphereBody.position.set(i + 2, j, -23);
                      sphereBody.position.vadd(hfBody.position, sphereBody.position);
                      world.addBody(sphereBody);
                      demo.addVisual(sphereBody);
                    // }
                }
            }
        });

      demo.start();

    </script>
  </body>
</html>
